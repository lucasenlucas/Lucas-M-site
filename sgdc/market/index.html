<script src="../js/bits.js"></script>
<script src="./market.js?v=3"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  if(!window.Market){
    document.getElementById('assetGrid').innerHTML =
      `<div class="card"><div>‚ö†Ô∏è Kan <code>market.js</code> niet laden. Check het script-pad.</div></div>`;
    return;
  }

  // Tabs
  const tabMarket = document.getElementById('tabMarket');
  const tabWallet = document.getElementById('tabWallet');
  const marketView = document.getElementById('marketView');
  const walletView = document.getElementById('walletView');
  const showMarket = ()=>{ tabMarket.classList.add('active'); tabWallet.classList.remove('active'); marketView.style.display='block'; walletView.style.display='none'; };
  const showWallet = ()=>{ tabWallet.classList.add('active'); tabMarket.classList.remove('active'); walletView.style.display='block'; marketView.style.display='none'; };
  tabMarket.onclick = showMarket; tabWallet.onclick = showWallet;

  function renderSummary(){
    const b = Market.bits.get();
    document.getElementById('bitsHeader').textContent = b;
    document.getElementById('bitsWallet').textContent = b;

    const invested = Market.portfolioValue();
    document.getElementById('bitsInvested').textContent = invested;

    const {now, y} = Market.indexNowY();
    const pct = ((now - y)/y)*100;
    const el = document.getElementById('marketDelta');
    el.textContent = (pct>=0?'+':'') + pct.toFixed(2) + '%';
    el.style.color = pct>=0 ? 'var(--good)' : 'var(--bad)';

    document.getElementById('walletFree').textContent = b;
    document.getElementById('walletLocked').textContent = invested;
    document.getElementById('walletTotal').textContent = b + invested;
  }

  function renderGrid(){
    const wrap = document.getElementById('assetGrid');
    wrap.innerHTML = Market.symbols().map(sym=>{
      const a = Market.assets[sym];
      const pct = ((a.price - a.yClose)/a.yClose)*100;
      const cls = pct>=0 ? 'up':'down';
      const m = Market.meta[sym];
      return `
        <a class="card" href="./asset.html?symbol=${encodeURIComponent(sym)}">
          <div class="row">
            <div style="display:flex;gap:10px;align-items:center">
              <div class="pill" style="border:none;background:#ffffff22">${m.ui.icon || 'üì¶'}</div>
              <div>
                <div class="name">${m.name}</div>
                <div class="ticker">${sym}</div>
              </div>
            </div>
            <div style="text-align:right">
              <div class="name">‚Çø${a.price.toFixed(2)}</div>
              <div class="pill ${cls}">${pct>=0?'+':''}${pct.toFixed(2)}%</div>
            </div>
          </div>
        </a>
      `;
    }).join('');
  }

  function renderPositions(){
    const body = document.getElementById('posBody');
    const rows = [];
    for(const [sym,pos] of Object.entries(Market.portfolio())){
      const a = Market.assets[sym];
      const plAbs = (a.price - pos.avg) * pos.qty;
      const plPct = (a.price - pos.avg) / pos.avg * 100;
      rows.push(`
        <tr>
          <td><strong>${sym}</strong></td>
          <td>${pos.qty}</td>
          <td>‚Çø${pos.avg.toFixed(2)}</td>
          <td>‚Çø${a.price.toFixed(2)}</td>
          <td style="color:${plAbs>=0?'var(--good)':'var(--bad)'}">
            ${plAbs>=0?'+':''}${plAbs.toFixed(2)} (${plPct>=0?'+':''}${plPct.toFixed(2)}%)
          </td>
          <td class="actions">
            <a class="btn" href="./asset.html?symbol=${encodeURIComponent(sym)}">Beheer</a>
          </td>
        </tr>
      `);
    }
    body.innerHTML = rows.length? rows.join('') : `<tr><td colspan="6" class="text-muted">Nog geen posities.</td></tr>`;
  }

  // Init + listeners
  Market.init();
  Market.bits.onChange(()=>{ renderSummary(); });  // sync met echte Bits-module
  document.getElementById('boxWallet').onclick = showWallet;

  // Langzamere loops
  setInterval(()=>{ Market.tickAll(); }, 2000);     // prijs elke 2s
  setInterval(()=>{                                 // UI elke 1.5s (met "hold")
    if(Math.random()<0.75){ renderSummary(); renderGrid(); renderPositions(); }
  }, 1500);

  // eerste render
  renderSummary(); renderGrid(); renderPositions();
});
</script>
