<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SGDC Live — Crash</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;600;700;800&display=swap" rel="stylesheet" />
  <style>
    :root{
      --bg:#0e1023;--panel:#171a37;--card:#141736;--text:#e8ecff;--muted:#a2a9d6;
      --accent:#f4b73b;--good:#4bd37b;--warn:#ff6b6b;--border:rgba(255,255,255,.12);
      --shadow:0 10px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,sans-serif;background:var(--bg);color:var(--text)}

    /* Topbar */
    .topbar{background:rgba(23,26,55,.9);backdrop-filter:blur(10px);
      display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--border);position:sticky;top:0;z-index:10}
    .brand{display:flex;align-items:center;gap:10px;font-weight:800}
    .brand img{width:28px;height:28px;border-radius:6px}
    .ghost{background:transparent;border:1px solid var(--border);color:var(--text);padding:8px 12px;border-radius:10px;text-decoration:none}
    .ghost:hover{background:rgba(255,255,255,.06)}
    .balance{font-weight:800;color:var(--good)}

    /* Layout */
    .wrap{max-width:1100px;margin:20px auto;padding:0 16px;display:grid;grid-template-columns:360px 1fr;gap:18px}
    @media (max-width:900px){ .wrap{grid-template-columns:1fr} }
    .below{max-width:1100px;margin:12px auto 28px;padding:0 16px}

    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:var(--shadow)}
    .title{margin:0 0 10px}
    .muted{color:var(--muted)}

    /* Inputs (compact) */
    .group{display:grid;gap:12px}
    .input{display:flex;align-items:center;gap:8px;background:#0b0d25;border:1px solid var(--border);border-radius:12px;padding:8px 10px}
    .input:focus-within{border-color:#ffffff33;box-shadow:0 0 0 3px #ffffff14}
    .input input{flex:1;background:transparent;border:0;color:var(--text);font:inherit;outline:none;min-width:0;max-width:110px}
    .suffix{opacity:.9;font-weight:800}

    .btn{padding:9px 12px;border:none;border-radius:12px;font-weight:800;cursor:pointer}
    .btn.primary{background:var(--accent);color:#2a1b00}
    .btn.secondary{background:transparent;border:1px solid var(--border);color:var(--text)}
    .btn:disabled{opacity:.6;cursor:not-allowed}

    .kpis{display:flex;flex-wrap:wrap;gap:10px}
    .chip{background:rgba(255,255,255,.08);padding:8px 10px;border-radius:12px;display:inline-flex;gap:6px;align-items:center}
    .kpi{font-weight:800}

    /* Right: stage + big multiplier */
    .stage{position:relative;overflow:hidden}
    .big-mult{
      position:absolute;left:50%;top:50%;transform:translate(-50%,-55%);
      font-size:clamp(36px,8vw,80px);font-weight:800;letter-spacing:1px;
      text-shadow:0 2px 10px rgba(0,0,0,.35);
    }
    .big-mult.ok{color:var(--good)}
    .big-mult.warn{color:var(--warn)}

    canvas{width:100%;height:min(52vh,420px);background:#0b0d25;border:1px solid var(--border);border-radius:16px}

    .shake{animation:shake .6s ease both}
    @keyframes shake{10%,90%{transform:translateX(-1px)}20%,80%{transform:translateX(2px)}30%,50%,70%{transform:translateX(-4px)}40%,60%{transform:translateX(4px)}}

    /* Confetti */
    .confetti{position:fixed;left:0;top:0;width:100vw;height:0;overflow:visible;pointer-events:none;z-index:20}
    .piece{position:absolute;width:8px;height:12px;opacity:.9;animation:fall linear forwards}
    @keyframes fall{to{transform:translateY(110vh) rotate(720deg);opacity:1}}

    /* Results below */
    table{width:100%;border-collapse:collapse}
    th,td{padding:6px;border-bottom:1px solid rgba(255,255,255,.08);text-align:left}
    th{color:var(--muted);font-weight:700}
  </style>
</head>
<body>
  <script src="../js/bits.js"></script>

  <header class="topbar">
    <a href="../" class="ghost">← Terug</a>
    <div class="brand">
      <img src="https://groep8sgdc.nl/wp-content/uploads/2022/09/s-Gravendreef-scholen07-01-18-1.png" alt="SGDC logo">
      Crash
    </div>
    <div class="balance">Bits: <span id="bitsValue">0</span></div>
  </header>

  <main class="wrap">
    <!-- LEFT: Controls -->
    <section class="card group">
      <h2 class="title">Inzetten</h2>

      <label class="input" title="Inzet">
        <span>Inzet</span>
        <input type="number" id="bet" min="1" step="1" value="10" inputmode="numeric" />
        <span class="suffix">Bits</span>
      </label>

      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <button class="btn primary" id="startBtn">Start ronde</button>
        <button class="btn secondary" id="cashBtn" disabled>Cash out</button>
        <button class="btn secondary" id="resetBtn">Reset</button>
      </div>

      <div class="kpis">
        <span class="chip">Status: <span class="kpi" id="status">Wachten…</span></span>
        <span class="chip">Crash @ <span class="kpi" id="crashAt">?</span>×</span>
        <span class="chip">Laatste winst: <span class="kpi" id="lastWin">0</span> Bits</span>
      </div>
    </section>

    <!-- RIGHT: Stage -->
    <section class="card stage" id="stageCard">
      <div class="big-mult ok" id="bigMult">1.00×</div>
      <canvas id="chart" width="720" height="420"></canvas>
      <svg class="confetti" id="confetti"></svg>
    </section>
  </main>

  <!-- RESULTS UNDER -->
  <section class="below">
    <div class="card">
      <h2 class="title">Resultaten</h2>
      <div id="summary" class="muted" style="margin-bottom:8px">Nog geen ronde gespeeld.</div>
      <div id="historyBox" class="muted"></div>
    </div>
  </section>

<script>
  // Bits hookup
  Bits.onChange(v => { document.getElementById("bitsValue").textContent = v; });

  // Elements
  const betEl  = document.getElementById('bet');
  const startBtn = document.getElementById('startBtn');
  const cashBtn  = document.getElementById('cashBtn');
  const resetBtn = document.getElementById('resetBtn');

  const statusEl = document.getElementById('status');
  const crashEl  = document.getElementById('crashAt');
  const lastWinEl= document.getElementById('lastWin');

  const bigMult  = document.getElementById('bigMult');
  const stage    = document.getElementById('stageCard');
  const confetti = document.getElementById('confetti');

  const summary  = document.getElementById('summary');

  const cvs = document.getElementById('chart');
  const ctx = cvs.getContext('2d');

  // State
  let running = false, crashed = false, startTs = 0, rafId = null;
  let currentMult = 1.00, crashPoint = 2.00, paidOut = false;

  // History (local)
  const HK = 'sgdc.crash.history';
  function loadHistory(){ try{return JSON.parse(localStorage.getItem(HK)||'[]')}catch{return []} }
  function saveHistory(h){ localStorage.setItem(HK, JSON.stringify(h.slice(0,50))); }
  function pushHistory(row){
    const h = loadHistory(); h.unshift(row);
    saveHistory(h); renderHistory();
  }
  function renderHistory(){
    const h = loadHistory();
    if(h.length===0){
      document.getElementById('historyBox').innerHTML = '<p class="muted">Nog geen rondes.</p>';
      return;
    }
    const rows = h.map(x=>`<tr>
      <td>${new Date(x.ts).toLocaleString()}</td>
      <td>${x.crash.toFixed(2)}×</td>
      <td>${x.bet}</td>
      <td>${x.cash? x.cash.toFixed(2)+'×' : '—'}</td>
      <td>${x.payout}</td>
    </tr>`).join('');
    document.getElementById('historyBox').innerHTML =
      `<div style="overflow:auto"><table>
        <thead><tr><th>Datum/Tijd</th><th>Crash</th><th>Inzet</th><th>Cash @</th><th>Payout</th></tr></thead>
        <tbody>${rows}</tbody>
      </table></div>`;
  }
  renderHistory();

  // Crash point sampler (heavy tail, cap ~50x)
  function sampleCrash(){
    const u = Math.min(0.999999, Math.max(1e-9, Math.random()));
    const scale = 1.3;
    const m = 1 + (-Math.log(1 - u)) * scale;
    return Math.min(50, m);
  }

  // Chart helpers
  function clearChart(){
    ctx.fillStyle = '#0b0d25'; ctx.fillRect(0,0,cvs.width,cvs.height);
    ctx.strokeStyle = 'rgba(255,255,255,.08)';
    ctx.beginPath();
    ctx.moveTo(40, cvs.height-30); ctx.lineTo(cvs.width-10, cvs.height-30);
    ctx.moveTo(40, cvs.height-30); ctx.lineTo(40, 10);
    ctx.stroke();
  }
  function drawCurve(mult){
    clearChart();
    const maxX = 8.0; // sec window
    const elapsed = (performance.now() - startTs)/1000;
    const t = Math.max(0.001, Math.min(elapsed, maxX));

    const h = cvs.height-30, w = cvs.width-50, originX=40, originY=h;
    ctx.strokeStyle = '#ffd774';
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(originX, originY);
    const steps = 120;
    for(let i=0;i<=steps;i++){
      const tt = (t*i/steps);
      const mAt = 1 + (mult-1)*(tt/(t||1));
      const y = originY - (Math.log(mAt)* (h*0.8) / Math.log(50)); // log scale
      const x = originX + (w * (tt/maxX));
      ctx.lineTo(x, y);
    }
    ctx.stroke();

    if(crashed){
      ctx.strokeStyle = '#ff6b6b';
      ctx.setLineDash([6,6]);
      const yCrash = originY - (Math.log(crashPoint)* (h*0.8) / Math.log(50));
      ctx.beginPath(); ctx.moveTo(originX, yCrash); ctx.lineTo(originX+w, yCrash); ctx.stroke();
      ctx.setLineDash([]);
    }
  }

  // Confetti
  function launchConfetti(){
    confetti.innerHTML = '';
    const colors = ['#ffd774','#f8b93d','#8a7cff','#4bd37b','#ff6b6b','#7c8bff'];
    const pieces = 80;
    for(let i=0;i<pieces;i++){
      const d = document.createElement('div');
      d.className='piece';
      d.style.left = Math.random()*100 + 'vw';
      d.style.top  = (-10 - Math.random()*40) +'px';
      d.style.background = colors[i%colors.length];
      d.style.animationDuration = (0.9 + Math.random()*0.9) + 's';
      d.style.animationDelay = (Math.random()*0.2)+'s';
      confetti.appendChild(d);
    }
    setTimeout(()=> confetti.innerHTML='', 1800);
  }

  // Flow
  function resetStage(){
    cancelAnimationFrame(rafId); rafId=null;
    running=false; crashed=false; currentMult=1.00; paidOut=false;
    bigMult.textContent = '1.00×'; bigMult.className='big-mult ok';
    statusEl.textContent='Wachten…'; crashEl.textContent='?';
    cashBtn.disabled = true;
    clearChart();
    summary.textContent = 'Nog geen ronde gespeeld.';
  }

  function startRound(){
    if(running) return;
    const bet = Math.max(1, parseInt(betEl.value,10)||1);
    if(!Bits.spend(bet)){
      statusEl.textContent='Niet genoeg Bits';
      stage.classList.add('shake'); setTimeout(()=>stage.classList.remove('shake'), 620);
      return;
    }
    crashPoint = sampleCrash();
    startTs = performance.now();
    running = true; crashed = false; paidOut = false;
    statusEl.textContent='Bezig…'; crashEl.textContent='?';
    cashBtn.disabled = false;
    bigMult.className='big-mult ok';
    animate(bet);
  }

  function animate(bet){
    const speed = 0.28; // growth factor
    function frame(){
      if(!running) return;
      const dt = 16/1000;
      currentMult = currentMult * (1 + speed*dt);

      if(currentMult >= crashPoint){
        currentMult = crashPoint;
        crashed = true; running = false;
        cashBtn.disabled = true;
        bigMult.className='big-mult warn';
        statusEl.textContent = `Gecrasht @ ${crashPoint.toFixed(2)}×`;
        stage.classList.add('shake'); setTimeout(()=>stage.classList.remove('shake'), 620);

        const payout = paidOut ? Math.floor(bet * paidOut) : 0;
        pushHistory({ts:Date.now(), crash: crashPoint, bet, cash: paidOut||null, payout});
        renderSummary(bet, payout, paidOut ? paidOut : null, crashPoint);
        drawCurve(currentMult);
        return;
      }

      bigMult.textContent = currentMult.toFixed(2)+'×';
      drawCurve(currentMult);
      rafId = requestAnimationFrame(frame);
    }
    rafId = requestAnimationFrame(frame);
  }

  function cashOut(){
    if(!running || crashed || paidOut) return;
    paidOut = currentMult; // multiplier op moment van cash
    const bet = Math.max(1, parseInt(betEl.value,10)||1);
    const payout = Math.floor(bet * paidOut);
    Bits.add(payout);
    lastWinEl.textContent = String(payout);
    statusEl.textContent = `Gecashed @ ${paidOut.toFixed(2)}× → +${payout} Bits`;
    cashBtn.disabled = true;
    launchConfetti();
  }

  function renderSummary(bet, payout, cashMult, crashAt){
    const cashTxt  = cashMult ? `${cashMult.toFixed(2)}×` : '—';
    const result   = payout>0 ? `WIN +${payout} Bits` : `LOSE 0`;
    summary.innerHTML = `
      Laatste ronde — Inzet: <b>${bet}</b> · Cash @ <b>${cashTxt}</b> · Crash @ <b>${crashAt.toFixed(2)}×</b> · Resultaat: <b>${result}</b>
    `;
  }

  function hardReset(){ resetStage(); }

  // Wire up
  startBtn.addEventListener('click', startRound);
  cashBtn .addEventListener('click', cashOut);
  resetBtn.addEventListener('click', hardReset);

  // Init
  resetStage();
  renderHistory();
</script>
</body>
</html>
