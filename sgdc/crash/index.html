<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SGDC Live — Crash</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;600;700;800&display=swap" rel="stylesheet" />
  <style>
    :root{
      --bg:#0b0f1e; --panel:#121632; --card:#121734; --text:#e9edff; --muted:#a2a9d6;
      --acc:#f7c552; --good:#4bd37b; --warn:#ff6b6b; --border:rgba(255,255,255,.12);
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --glass:rgba(18,23,52,.7);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Arial; color:var(--text);
      background: radial-gradient(1200px 700px at 15% -10%, #1a1f46 0%, transparent 60%),
                  radial-gradient(900px 600px at 110% -20%, #261348 0%, transparent 60%),
                  var(--bg);
    }

    /* Topbar */
    .topbar{
      position:sticky; top:0; z-index:20;
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; padding:12px 16px;
      background:linear-gradient(180deg, rgba(10,12,28,.85), rgba(10,12,28,.55));
      backdrop-filter:blur(10px);
      border-bottom:1px solid var(--border);
    }
    .brand{display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.2px}
    .brand img{width:28px; height:28px; border-radius:6px}
    .ghost{
      position:relative;
      background:transparent; border:1px solid var(--border); color:var(--text);
      padding:8px 12px; border-radius:10px; text-decoration:none; font-weight:600;
      transition:transform .18s ease, background .18s ease, border-color .18s ease;
    }
    .ghost:hover{ background:rgba(255,255,255,.06); transform:translateY(-1px); border-color:#ffffff2a }
    .balance{font-weight:800; color:var(--good)}

    /* Layout */
    .wrap{max-width:1100px; margin:20px auto; padding:0 16px; display:grid; grid-template-columns:360px 1fr; gap:18px}
    @media (max-width:900px){ .wrap{grid-template-columns:1fr} }
    .below{max-width:1100px; margin:12px auto 28px; padding:0 16px}

    .card{
      background:linear-gradient(180deg, #121734, #0e122b);
      border:1px solid var(--border); border-radius:16px; padding:16px; box-shadow:var(--shadow);
    }
    .title{margin:0 0 10px}
    .muted{color:var(--muted)}

    /* Inputs */
    .group{display:grid; gap:12px}
    .input{
      display:flex; align-items:center; gap:10px;
      background:linear-gradient(180deg,#0b0d25,#0b0d22);
      border:1px solid var(--border); border-radius:12px; padding:10px 12px;
      transition:border-color .2s ease, box-shadow .2s ease;
    }
    .input:focus-within{ border-color:#ffffff33; box-shadow:0 0 0 4px #ffffff10 }
    .input input{ flex:1; background:transparent; border:0; color:var(--text); font:inherit; outline:none; min-width:0; max-width:120px }
    .suffix{ opacity:.9; font-weight:800 }

    .row{display:flex; gap:10px; flex-wrap:wrap}

    .btn{
      position:relative; overflow:hidden;
      padding:10px 14px; border:none; border-radius:12px; font-weight:800; cursor:pointer;
      transform:translateZ(0);
      transition:transform .15s ease, box-shadow .15s ease, opacity .2s ease, background .2s ease;
      will-change:transform;
    }
    .btn:active{ transform:translateY(1px) }
    .btn.primary{ background:linear-gradient(180deg, #ffd774, #f5b642); color:#2a1b00; box-shadow:0 6px 16px rgba(245,182,66,.25) }
    .btn.primary:hover{ box-shadow:0 10px 22px rgba(245,182,66,.35) }
    .btn.secondary{ background:transparent; border:1px solid var(--border); color:var(--text) }
    .btn:disabled{ opacity:.55; cursor:not-allowed }

    /* Button ripple */
    .btn::after{
      content:""; position:absolute; left:50%; top:50%; width:0; height:0; border-radius:50%;
      background:rgba(255,255,255,.25); transform:translate(-50%,-50%); transition:width .35s ease,height .35s ease,opacity .45s ease;
      pointer-events:none;
    }
    .btn.ripple::after{ width:220px; height:220px; opacity:0 }

    /* Chips */
    .kpis{display:flex; flex-wrap:wrap; gap:10px}
    .chip{
      display:inline-flex; gap:6px; align-items:center;
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      padding:8px 10px; border-radius:999px; border:1px solid var(--border);
      animation:fadeIn .35s ease both;
    }
    .kpi{font-weight:800}
    @keyframes fadeIn{from{opacity:0; transform:translateY(4px)}}

    /* Stage */
    .stage{position:relative; overflow:hidden; padding:0}
    .stage-inner{ position:relative; padding:16px }
    .big-mult{
      position:absolute; left:50%; top:50%; transform:translate(-50%,-54%);
      font-size:clamp(40px,8.5vw,86px); font-weight:900; letter-spacing:.5px;
      text-shadow:0 6px 24px rgba(0,0,0,.5), 0 0 40px rgba(255,255,255,.08);
      filter:drop-shadow(0 8px 24px rgba(0,0,0,.45));
      transition:transform .18s ease;
      will-change:transform;
      pointer-events:none;
    }
    .big-mult.ok{ color:#d9ffd6 }
    .big-mult.warn{ color:#ffd0d0; animation:dangerPulse .8s ease-in-out infinite }
    @keyframes dangerPulse{ 0%,100%{ text-shadow:0 6px 24px rgba(0,0,0,.5), 0 0 24px rgba(255,107,107,.45) } 50%{ text-shadow:0 6px 24px rgba(0,0,0,.5), 0 0 46px rgba(255,107,107,.7) } }

    canvas{
      width:100%; height:min(52vh,420px);
      background:
        radial-gradient(1200px 600px at 20% -30%, rgba(255,215,116,.15), transparent 60%),
        #0b0d25;
      border:1px solid var(--border); border-radius:16px;
      display:block;
    }

    /* Progress bar to crash */
    .progress{
      position:absolute; left:16px; right:16px; bottom:14px; height:8px;
      background:rgba(255,255,255,.06); border-radius:999px; overflow:hidden; border:1px solid var(--border)
    }
    .progress > span{
      display:block; height:100%;
      background:linear-gradient(90deg, #ffd774, #f5b642 50%, #ff9b42);
      width:0%;
      transition:width .12s linear;
      will-change:width;
    }
    .progress.near > span{ animation:barPulse .9s ease-in-out infinite }
    @keyframes barPulse{ 0%,100%{filter:saturate(100%)} 50%{filter:saturate(140%)} }

    .shake{ animation:shake .6s ease both }
    @keyframes shake{
      10%,90%{ transform:translateX(-1px) }
      20%,80%{ transform:translateX(2px) }
      30%,50%,70%{ transform:translateX(-4px) }
      40%,60%{ transform:translateX(4px) }
    }

    /* Confetti */
    .confetti{ position:fixed; left:0; top:0; width:100vw; height:0; overflow:visible; pointer-events:none; z-index:40 }
    .piece{ position:absolute; width:8px; height:12px; opacity:.9; animation:fall linear forwards }
    @keyframes fall{ to{ transform:translateY(110vh) rotate(720deg); opacity:1 } }

    /* Toasts */
    .toasts{ position:fixed; right:16px; bottom:16px; display:grid; gap:8px; z-index:50 }
    .toast{
      background:var(--glass); border:1px solid var(--border); border-radius:12px; padding:10px 12px; backdrop-filter:blur(8px);
      box-shadow:var(--shadow); animation:slideUp .25s ease both;
    }
    .toast.good{ border-color:rgba(75,211,123,.45) }
    .toast.bad{ border-color:rgba(255,107,107,.45) }
    @keyframes slideUp{ from{ transform:translateY(10px); opacity:0 } }

    /* Table */
    table{ width:100%; border-collapse:collapse }
    th,td{ padding:8px 6px; border-bottom:1px solid rgba(255,255,255,.08); text-align:left }
    th{ color:var(--muted); font-weight:700 }
    .fadein{ animation:fadeIn .35s ease both }

    /* Reduced motion */
    @media (prefers-reduced-motion:reduce){
      *{ animation:none !important; transition:none !important }
    }
  </style>
</head>
<body>
  <script src="../js/bits.js"></script>

  <header class="topbar">
    <a href="../" class="ghost">← Terug</a>
    <div class="brand">
      <img src="https://groep8sgdc.nl/wp-content/uploads/2022/09/s-Gravendreef-scholen07-01-18-1.png" alt="SGDC logo">
      Crash
    </div>
    <div class="balance">Bits: <span id="bitsValue">0</span></div>
  </header>

  <main class="wrap">
    <!-- LEFT: Controls -->
    <section class="card group" aria-label="Inzetten en besturing">
      <h2 class="title">Inzetten</h2>

      <label class="input" title="Inzet">
        <span>Inzet</span>
        <input type="number" id="bet" min="1" step="1" value="10" inputmode="numeric" aria-label="Inzet in Bits"/>
        <span class="suffix">Bits</span>
      </label>

      <div class="row">
        <button class="btn primary" id="startBtn">Start ronde</button>
        <button class="btn secondary" id="cashBtn" disabled>Cash out</button>
        <button class="btn secondary" id="resetBtn" title="Reset ronde">Reset</button>
      </div>

      <div class="kpis">
        <span class="chip">Status: <span class="kpi" id="status">Wachten…</span></span>
        <span class="chip">Crash @ <span class="kpi" id="crashAt">?</span>×</span>
        <span class="chip">Laatste winst: <span class="kpi" id="lastWin">0</span> Bits</span>
      </div>
    </section>

    <!-- RIGHT: Stage -->
    <section class="card stage" id="stageCard" aria-live="polite">
      <div class="stage-inner">
        <div class="big-mult ok" id="bigMult">1.00×</div>
        <canvas id="chart" width="720" height="420" aria-label="Crash grafiek"></canvas>
        <div class="progress" id="progress"><span></span></div>
      </div>
      <svg class="confetti" id="confetti" aria-hidden="true"></svg>
    </section>
  </main>

  <!-- RESULTS UNDER -->
  <section class="below">
    <div class="card">
      <h2 class="title">Resultaten</h2>
      <div id="summary" class="muted" style="margin-bottom:8px">Nog geen ronde gespeeld.</div>
      <div id="historyBox" class="muted"></div>
    </div>
  </section>

  <!-- Toasts -->
  <div class="toasts" id="toasts" aria-live="polite" aria-atomic="true"></div>

<script>
  // ——— Bits hookup
  Bits.onChange(v => { document.getElementById("bitsValue").textContent = v; });

  // ——— Elements
  const betEl     = document.getElementById('bet');
  const startBtn  = document.getElementById('startBtn');
  const cashBtn   = document.getElementById('cashBtn');
  const resetBtn  = document.getElementById('resetBtn');

  const statusEl  = document.getElementById('status');
  const crashEl   = document.getElementById('crashAt');
  const lastWinEl = document.getElementById('lastWin');

  const bigMult   = document.getElementById('bigMult');
  const stage     = document.getElementById('stageCard');
  const confetti  = document.getElementById('confetti');
  const progress  = document.getElementById('progress').firstElementChild;

  const summary   = document.getElementById('summary');
  const toasts    = document.getElementById('toasts');

  const cvs = document.getElementById('chart');
  const ctx = cvs.getContext('2d');

  // ——— State
  let running = false, crashed = false, startTs = 0, rafId = null;
  let currentMult = 1.00, crashPoint = 2.00, paidOut = false;
  const NEAR_RATIO = 0.85;   // wanneer tonen we “near crash” waarschuwing
  const MAX_MULT   = 50;

  // ——— History (local)
  const HK = 'sgdc.crash.history';
  function loadHistory(){ try{return JSON.parse(localStorage.getItem(HK)||'[]')}catch{return []} }
  function saveHistory(h){ localStorage.setItem(HK, JSON.stringify(h.slice(0,60))); }
  function pushHistory(row){
    const h = loadHistory(); h.unshift(row);
    saveHistory(h); renderHistory();
  }
  function renderHistory(){
    const h = loadHistory();
    if(h.length===0){
      document.getElementById('historyBox').innerHTML = '<p class="muted">Nog geen rondes.</p>';
      return;
    }
    const rows = h.map(x=>`<tr class="fadein">
      <td>${new Date(x.ts).toLocaleString()}</td>
      <td>${x.crash.toFixed(2)}×</td>
      <td>${x.bet}</td>
      <td>${x.cash? x.cash.toFixed(2)+'×' : '—'}</td>
      <td>${x.payout}</td>
    </tr>`).join('');
    document.getElementById('historyBox').innerHTML =
      `<div style="overflow:auto"><table>
        <thead><tr><th>Datum/Tijd</th><th>Crash</th><th>Inzet</th><th>Cash @</th><th>Payout</th></tr></thead>
        <tbody>${rows}</tbody>
      </table></div>`;
  }
  renderHistory();

  // ——— Utils
  function toast(msg, kind='good'){
    const el = document.createElement('div');
    el.className = `toast ${kind}`;
    el.textContent = msg;
    toasts.appendChild(el);
    setTimeout(()=>{ el.style.opacity='0'; el.style.transform='translateY(6px)'; }, 2100);
    setTimeout(()=> el.remove(), 2600);
  }
  function ripple(btn){
    btn.classList.remove('ripple');
    // force reflow
    void btn.offsetWidth;
    btn.classList.add('ripple');
  }

  // ——— Crash sampler (heavy tail, capped)
  function sampleCrash(){
    const u = Math.min(.999999, Math.max(1e-9, Math.random()));
    const scale = 1.3;
    const m = 1 + (-Math.log(1 - u)) * scale;
    return Math.min(MAX_MULT, m);
  }

  // ——— Chart helpers
  function clearChart(){
    // background
    ctx.fillStyle = '#0b0d25';
    ctx.fillRect(0,0,cvs.width,cvs.height);

    // grid
    ctx.strokeStyle = 'rgba(255,255,255,.08)';
    ctx.lineWidth = 1;
    ctx.beginPath();
    // axes
    ctx.moveTo(40, cvs.height-30); ctx.lineTo(cvs.width-10, cvs.height-30);
    ctx.moveTo(40, cvs.height-30); ctx.lineTo(40, 10);
    // h-grid lines
    for(let i=1;i<=4;i++){
      const y = (cvs.height-30) - i*((cvs.height-40)/5);
      ctx.moveTo(40, y); ctx.lineTo(cvs.width-10, y);
    }
    ctx.stroke();
  }

  // tiny particle trail
  const sparks = [];
  function addSpark(x,y){
    sparks.push({x,y,vx:(Math.random()*1.2)+.2, vy:(Math.random()*.6)-.3, life:16});
  }
  function drawSparks(){
    for(let i=sparks.length-1;i>=0;i--){
      const s = sparks[i];
      ctx.fillStyle = 'rgba(255,215,116,'+(s.life/16)+')';
      ctx.fillRect(s.x, s.y, 2, 2);
      s.x += s.vx; s.y += s.vy; s.life--;
      if(s.life<=0) sparks.splice(i,1);
    }
  }

  function drawCurve(mult){
    clearChart();
    const maxX = 8.0; // sec window
    const elapsed = Math.max(0, (performance.now() - startTs)/1000);

    const h = cvs.height-30, w = cvs.width-50, originX=40, originY=h;

    // curve
    ctx.strokeStyle = '#ffd774';
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(originX, originY);

    const steps = 140;
    for(let i=0;i<=steps;i++){
      const tt = Math.min(elapsed, maxX) * (i/steps);
      const frac = elapsed ? (tt/elapsed) : 0;
      const mAt = 1 + (mult-1)*frac;
      const y = originY - (Math.log(mAt) * (h*0.8) / Math.log(MAX_MULT));
      const x = originX + (w * (tt/maxX));
      ctx.lineTo(x, y);
      if(i===steps){ addSpark(x,y); }
    }
    ctx.stroke();

    // crash line
    if(crashed){
      ctx.strokeStyle = '#ff6b6b';
      ctx.setLineDash([6,6]);
      const yCrash = originY - (Math.log(crashPoint)* (h*0.8) / Math.log(MAX_MULT));
      ctx.beginPath(); ctx.moveTo(originX, yCrash); ctx.lineTo(originX+w, yCrash); ctx.stroke();
      ctx.setLineDash([]);
    }

    drawSparks();
  }

  // ——— Confetti
  function launchConfetti(){
    confetti.innerHTML = '';
    const colors = ['#ffd774','#f8b93d','#8a7cff','#4bd37b','#ff6b6b','#7c8bff'];
    const pieces = 90;
    for(let i=0;i<pieces;i++){
      const d = document.createElement('div');
      d.className='piece';
      d.style.left = Math.random()*100 + 'vw';
      d.style.top  = (-10 - Math.random()*40) +'px';
      d.style.background = colors[i%colors.length];
      d.style.animationDuration = (0.9 + Math.random()*1.1) + 's';
      d.style.animationDelay = (Math.random()*0.25)+'s';
      confetti.appendChild(d);
    }
    setTimeout(()=> confetti.innerHTML='', 1900);
  }

  // ——— Flow
  function resetStage(){
    cancelAnimationFrame(rafId); rafId=null;
    running=false; crashed=false; currentMult=1.00; paidOut=false;
    bigMult.textContent = '1.00×'; bigMult.className='big-mult ok';
    statusEl.textContent='Wachten…'; crashEl.textContent='?';
    cashBtn.disabled = true;
    document.getElementById('progress').classList.remove('near');
    document.getElementById('progress').firstElementChild.style.width = '0%';
    clearChart();
    summary.textContent = 'Nog geen ronde gespeeld.';
  }

  function startRound(){
    if(running) return;
    ripple(startBtn);

    const bet = Math.max(1, parseInt(betEl.value,10)||1);
    if(!Bits.spend(bet)){
      statusEl.textContent='Niet genoeg Bits';
      stage.classList.add('shake'); setTimeout(()=>stage.classList.remove('shake'), 620);
      toast('Niet genoeg Bits','bad');
      return;
    }
    crashPoint = sampleCrash();
    startTs = performance.now();
    running = true; crashed = false; paidOut = false;

    statusEl.textContent='Bezig…'; crashEl.textContent='?';
    cashBtn.disabled = false;
    bigMult.className='big-mult ok';
    animate(bet);
  }

  function animate(bet){
    const speed = 0.28; // groei per frame
    function frame(){
      if(!running) return;
      const dt = 16/1000;
      currentMult = currentMult * (1 + speed*dt);

      // progress bar updaten
      const ratio = Math.min(1, currentMult / crashPoint);
      progress.style.width = (ratio*100).toFixed(2)+'%';
      const progWrap = document.getElementById('progress').parentElement.querySelector('.progress');
      if(ratio > NEAR_RATIO){ progWrap?.classList.add('near'); }

      // near-crash feedback
      if(currentMult > crashPoint*NEAR_RATIO && !crashed){
        bigMult.className = 'big-mult warn';
      }

      // crash?
      if(currentMult >= crashPoint){
        currentMult = crashPoint;
        crashed = true; running = false;
        cashBtn.disabled = true;
        bigMult.className='big-mult warn';
        statusEl.textContent = `Gecrasht @ ${crashPoint.toFixed(2)}×`;
        stage.classList.add('shake'); setTimeout(()=>stage.classList.remove('shake'), 620);

        const payout = paidOut ? Math.floor(bet * paidOut) : 0;
        pushHistory({ts:Date.now(), crash: crashPoint, bet, cash: paidOut||null, payout});
        renderSummary(bet, payout, paidOut ? paidOut : null, crashPoint);
        drawCurve(currentMult);

        if(!paidOut){ toast('LOSE — 0 Bits','bad'); }
        return;
      }

      // tick
      bigMult.textContent = currentMult.toFixed(2)+'×';
      // tiny scale wobble for feel
      bigMult.style.transform = `translate(-50%,-54%) scale(${1 + Math.min(.06, currentMult/120)})`;

      drawCurve(currentMult);
      rafId = requestAnimationFrame(frame);
    }
    rafId = requestAnimationFrame(frame);
  }

  function cashOut(){
    if(!running || crashed || paidOut) return;
    ripple(cashBtn);

    paidOut = currentMult; // multiplier op moment van cash
    const bet = Math.max(1, parseInt(betEl.value,10)||1);
    const payout = Math.floor(bet * paidOut);
    Bits.add(payout);
    lastWinEl.textContent = String(payout);
    statusEl.textContent = `Gecashed @ ${paidOut.toFixed(2)}× → +${payout} Bits`;
    launchConfetti();
    toast(`WIN +${payout} Bits @ ${paidOut.toFixed(2)}×`, 'good');
  }

  function renderSummary(bet, payout, cashMult, crashAt){
    const cashTxt  = cashMult ? `${cashMult.toFixed(2)}×` : '—';
    const result   = payout>0 ? `WIN +${payout} Bits` : `LOSE 0`;
    summary.innerHTML = `
      Laatste ronde — Inzet: <b>${bet}</b> · Cash @ <b>${cashTxt}</b> · Crash @ <b>${crashAt.toFixed(2)}×</b> · Resultaat: <b>${result}</b>
    `;
  }

  function hardReset(){
    ripple(resetBtn);
    resetStage();
  }

  // ——— Wire up
  startBtn.addEventListener('click', startRound);
  cashBtn .addEventListener('click', cashOut);
  resetBtn.addEventListener('click', hardReset);

  // Keyboard shortcuts
  window.addEventListener('keydown', (e)=>{
    if(e.key==='s' || e.key==='S') startRound();
    if(e.key==='c' || e.key==='C') cashOut();
    if(e.key==='r' || e.key==='R') hardReset();
  });

  // ——— Init
  resetStage();
  renderHistory();
</script>
</body>
</html>
