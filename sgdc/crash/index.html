<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SGDC Live — Crash</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;600;700;800&display=swap" rel="stylesheet" />
  <style>
    :root{
      --bg:#0e1023;--panel:#171a37;--card:#141736;--text:#e8ecff;--muted:#a2a9d6;
      --accent:#f4b73b;--good:#4bd37b;--warn:#ff6b6b;--border:rgba(255,255,255,.12);
      --shadow:0 10px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,sans-serif;background:var(--bg);color:var(--text);overflow-x:hidden}

    /* Topbar */
    .topbar{background:rgba(23,26,55,.9);backdrop-filter:blur(10px);
      display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--border);position:sticky;top:0;z-index:10}
    .brand{display:flex;align-items:center;gap:10px;font-weight:800}
    .brand img{width:28px;height:28px;border-radius:6px}
    .ghost{background:transparent;border:1px solid var(--border);color:var(--text);padding:8px 12px;border-radius:10px;text-decoration:none}
    .ghost:hover{background:rgba(255,255,255,.06)}
    .balance{font-weight:800;color:var(--good)}

    /* Layout */
    .wrap{max-width:1100px;margin:20px auto;padding:0 16px;display:grid;grid-template-columns:360px 1fr;gap:18px}
    @media (max-width:900px){ .wrap{grid-template-columns:1fr} }

    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:var(--shadow)}
    .title{margin:0 0 10px}
    .muted{color:var(--muted)}

    /* Inputs (compact) */
    .group{display:grid;gap:12px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .input{display:flex;align-items:center;gap:8px;background:#0b0d25;border:1px solid var(--border);border-radius:12px;padding:8px 10px}
    .input:focus-within{border-color:#ffffff33;box-shadow:0 0 0 3px #ffffff14}
    .input input, .input select{flex:1;background:transparent;border:0;color:var(--text);font:inherit;outline:none;min-width:0}
    .input input[type="number"]{max-width:110px}
    .suffix{opacity:.9;font-weight:800}

    .btn{padding:9px 12px;border:none;border-radius:12px;font-weight:800;cursor:pointer}
    .btn.primary{background:var(--accent);color:#2a1b00}
    .btn.secondary{background:transparent;border:1px solid var(--border);color:var(--text)}
    .btn:disabled{opacity:.6;cursor:not-allowed}

    .kpis{display:flex;flex-wrap:wrap;gap:10px}
    .chip{background:rgba(255,255,255,.08);padding:8px 10px;border-radius:12px;display:inline-flex;gap:6px;align-items:center}
    .kpi{font-weight:800}

    /* Right: chart + big multiplier */
    .stage{position:relative;overflow:hidden}
    .big-mult{
      position:absolute;left:50%;top:50%;transform:translate(-50%,-55%);
      font-size:clamp(36px,8vw,80px);font-weight:800;letter-spacing:1px;
      text-shadow:0 2px 10px rgba(0,0,0,.35);
    }
    .big-mult.ok{color:var(--good)}
    .big-mult.warn{color:var(--warn)}
    .seedline{margin-top:8px}

    canvas{width:100%;height:min(52vh,420px);background:#0b0d25;border:1px solid var(--border);border-radius:16px}

    .shake{animation:shake .6s ease both}
    @keyframes shake{10%,90%{transform:translateX(-1px)}20%,80%{transform:translateX(2px)}30%,50%,70%{transform:translateX(-4px)}40%,60%{transform:translateX(4px)}}

    /* Confetti */
    .confetti{position:fixed;left:0;top:0;width:100vw;height:0;overflow:visible;pointer-events:none;z-index:20}
    .piece{position:absolute;width:8px;height:12px;opacity:.9;animation:fall linear forwards}
    @keyframes fall{to{transform:translateY(110vh) rotate(720deg);opacity:1}}

    /* History */
    table{width:100%;border-collapse:collapse}
    th,td{padding:6px;border-bottom:1px solid rgba(255,255,255,.08);text-align:left}
    th{color:var(--muted);font-weight:700}
  </style>
</head>
<body>
  <script src="../js/bits.js"></script>

  <header class="topbar">
    <a href="../" class="ghost">← Terug</a>
    <div class="brand">
      <img src="https://groep8sgdc.nl/wp-content/uploads/2022/09/s-Gravendreef-scholen07-01-18-1.png" alt="SGDC logo">
      Crash
    </div>
    <div class="balance">Bits: <span id="bitsValue">0</span></div>
  </header>

  <main class="wrap">
    <!-- LEFT: Controls -->
    <section class="card group">
      <h2 class="title">Inzetten</h2>

      <div class="row">
        <label class="input" title="Inzet">
          <span>Inzet</span>
          <input type="number" id="bet" min="1" step="1" value="10" inputmode="numeric" />
          <span class="suffix">Bits</span>
        </label>

        <label class="input" title="Auto cash-out bij deze multiplier (optioneel)">
          <span>Auto-cash</span>
          <input type="number" id="auto" min="1.01" step="0.01" placeholder="(bv. 2.00)" />
          <span class="suffix">×</span>
        </label>
      </div>

      <label class="input" title="Seed (optioneel, voor reproduceerbare rondes)">
        <span>Seed</span>
        <input type="text" id="seed" placeholder="bv. sgdc-1234" />
      </label>

      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <button class="btn primary" id="startBtn">Start ronde</button>
        <button class="btn secondary" id="cashBtn" disabled>Cash out</button>
        <button class="btn secondary" id="resetBtn">Reset</button>
      </div>

      <div class="kpis">
        <span class="chip">Status: <span class="kpi" id="status">Wachten…</span></span>
        <span class="chip">Doel: <span class="kpi" id="goal">—</span></span>
        <span class="chip">Crash @ <span class="kpi" id="crashAt">?</span>×</span>
        <span class="chip">Laatste winst: <span class="kpi" id="lastWin">0</span> Bits</span>
      </div>

      <h3 class="title" style="margin-top:12px">Geschiedenis</h3>
      <div id="historyBox" class="muted"></div>
    </section>

    <!-- RIGHT: Stage -->
    <section class="card stage" id="stageCard">
      <div class="big-mult ok" id="bigMult">1.00×</div>
      <canvas id="chart" width="720" height="420"></canvas>
      <svg class="confetti" id="confetti"></svg>
      <div class="seedline muted" id="seedLine">Seed: —</div>
    </section>
  </main>

  <script>
    // Bits hookup
    Bits.onChange(v => { document.getElementById("bitsValue").textContent = v; });

    // Elements
    const betEl  = document.getElementById('bet');
    const autoEl = document.getElementById('auto');
    const seedEl = document.getElementById('seed');

    const startBtn = document.getElementById('startBtn');
    const cashBtn  = document.getElementById('cashBtn');
    const resetBtn = document.getElementById('resetBtn');

    const statusEl = document.getElementById('status');
    const goalEl   = document.getElementById('goal');
    const crashEl  = document.getElementById('crashAt');
    const lastWinEl= document.getElementById('lastWin');
    const seedLine = document.getElementById('seedLine');

    const bigMult  = document.getElementById('bigMult');
    const stage    = document.getElementById('stageCard');
    const confetti = document.getElementById('confetti');

    const cvs = document.getElementById('chart');
    const ctx = cvs.getContext('2d');

    // State
    let running = false, crashed = false, startTs = 0, rafId = null;
    let currentMult = 1.00, crashPoint = 2.00, paidOut = false;
    let rng = Math.random, nonce = 0;

    // History (local)
    const HK = 'sgdc.crash.history';
    function loadHistory(){ try{return JSON.parse(localStorage.getItem(HK)||'[]')}catch{return []} }
    function saveHistory(h){ localStorage.setItem(HK, JSON.stringify(h.slice(0,30))); }
    function pushHistory(row){
      const h = loadHistory(); h.unshift(row);
      saveHistory(h); renderHistory();
    }
    function renderHistory(){
      const h = loadHistory();
      if(h.length===0){ document.getElementById('historyBox').innerHTML = '<p class="muted">Nog geen rondes.</p>'; return; }
      const rows = h.map(x=>`<tr><td>${new Date(x.ts).toLocaleTimeString()}</td><td>${x.seed||'—'}</td><td>${x.crash.toFixed(2)}×</td><td>${x.bet}</td><td>${x.cash? x.cash.toFixed(2)+'×':'—'}</td><td>${x.payout}</td></tr>`).join('');
      document.getElementById('historyBox').innerHTML =
        `<div style="overflow:auto"><table><thead><tr><th>Tijd</th><th>Seed</th><th>Crash</th><th>Inzet</th><th>Cash @</th><th>Payout</th></tr></thead><tbody>${rows}</tbody></table></div>`;
    }
    renderHistory();

    // RNG helpers (seeded)
    function hashStringToSeed(str){ let h=1779033703^str.length; for(let i=0;i<str.length;i++){ h=Math.imul(h^str.charCodeAt(i),3432918353); h=(h<<13)|(h>>>19);} return (h>>>0)>>>0; }
    function mulberry32(a){ return function(){ let t=a+=0x6D2B79F5; t=Math.imul(t^t>>>15,t|1); t^=t+Math.imul(t^t>>>7,t|61); return ((t^t>>>14)>>>0)/4294967296; } }

    // Crash point sampler (heavy tail, max ~ 50x)
    // m = 1 + scale * -ln(1-u); capped
    function sampleCrash(randomFn){
      const u = Math.min(0.999999, Math.max(1e-9, randomFn()));
      const scale = 1.3; // grotere tail
      const m = 1 + (-Math.log(1 - u)) * scale;
      return Math.min(50, m); // cap
    }

    // Chart helpers
    function clearChart(){
      ctx.fillStyle = '#0b0d25'; ctx.fillRect(0,0,cvs.width,cvs.height);
      // axes
      ctx.strokeStyle = 'rgba(255,255,255,.08)';
      ctx.beginPath();
      ctx.moveTo(40, cvs.height-30); ctx.lineTo(cvs.width-10, cvs.height-30);
      ctx.moveTo(40, cvs.height-30); ctx.lineTo(40, 10);
      ctx.stroke();
    }
    function drawCurve(mult){
      clearChart();
      const maxX = 8.0; // sec window
      const elapsed = (performance.now() - startTs)/1000;
      const t = Math.min(elapsed, maxX);

      // simple exponential-ish mapping: m(t) ≈ 1 + growth*t then ease
      // we actually drive from currentMult directly, so just draw to that height
      const h = cvs.height-30, w = cvs.width-50, originX=40, originY=h;
      ctx.strokeStyle = '#ffd774';
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(originX, originY);
      const steps = 120;
      for(let i=0;i<=steps;i++){
        const tt = (t*i/steps);
        // fake back-calc y by assuming linear in time between 1 and mult
        const mAt = 1 + (mult-1)*(tt/(t||1));
        const y = originY - (Math.log(mAt)* (h*0.8) / Math.log(50)); // log scale
        const x = originX + (w * (tt/maxX));
        ctx.lineTo(x, y);
      }
      ctx.stroke();

      // crash line (if known & < current mult)
      if(crashed){
        ctx.strokeStyle = '#ff6b6b';
        ctx.setLineDash([6,6]);
        const yCrash = originY - (Math.log(crashPoint)* (h*0.8) / Math.log(50));
        ctx.beginPath(); ctx.moveTo(originX, yCrash); ctx.lineTo(originX+w, yCrash); ctx.stroke();
        ctx.setLineDash([]);
      }
    }

    // Confetti
    function launchConfetti(){
      confetti.innerHTML = '';
      const colors = ['#ffd774','#f8b93d','#8a7cff','#4bd37b','#ff6b6b','#7c8bff'];
      const pieces = 80;
      for(let i=0;i<pieces;i++){
        const d = document.createElement('div');
        d.className='piece';
        d.style.left = Math.random()*100 + 'vw';
        d.style.top  = (-10 - Math.random()*40) +'px';
        d.style.background = colors[i%colors.length];
        d.style.animationDuration = (0.9 + Math.random()*0.9) + 's';
        d.style.animationDelay = (Math.random()*0.2)+'s';
        confetti.appendChild(d);
      }
      setTimeout(()=> confetti.innerHTML='', 1800);
    }

    // Game flow
    function resetStage(){
      cancelAnimationFrame(rafId); rafId=null;
      running=false; crashed=false; paidOut=false; currentMult=1.00;
      bigMult.textContent = '1.00×'; bigMult.className='big-mult ok';
      statusEl.textContent='Wachten…'; goalEl.textContent='—'; crashEl.textContent='?';
      seedLine.textContent = 'Seed: —';
      cashBtn.disabled = true;
      clearChart();
    }

    function prepareRng(){
      const s = (seedEl.value||'').trim();
      if(!s){ rng = Math.random; seedLine.textContent = 'Seed: (random)'; return; }
      const base = hashStringToSeed(s + '|' + (nonce++));
      rng = mulberry32(base);
      seedLine.textContent = `Seed: ${s} · nonce ${nonce}`;
    }

    function startRound(){
      if(running) return;
      const bet = Math.max(1, parseInt(betEl.value,10)||1);
      const goal = parseFloat(autoEl.value);
      if(!Bits.spend(bet)){ statusEl.textContent='Niet genoeg Bits'; stage.classList.add('shake'); setTimeout(()=>stage.classList.remove('shake'), 620); return; }

      prepareRng();
      crashPoint = sampleCrash(rng);
      startTs = performance.now();
      running = true; crashed = false; paidOut = false;
      statusEl.textContent='Bezig…'; crashEl.textContent='?';
      goalEl.textContent = isFinite(goal) ? goal.toFixed(2)+'×' : '—';

      cashBtn.disabled = false;
      bigMult.className='big-mult ok';
      animate(bet, goal);
    }

    function animate(bet, goal){
      // Smooth multiplier growth: ~1% per 40ms => ~25%/sec → sneller dan lineair
      const speed = 0.28; // growth factor
      function frame(){
        if(!running){ return; }
        // grow exponential-ish
        const dt = 16/1000; // ~60fps
        currentMult = currentMult * (1 + speed*dt);
        // stop at crash
        if(currentMult >= crashPoint){
          currentMult = crashPoint;
          crashed = true; running = false;
          cashBtn.disabled = true;
          bigMult.className='big-mult warn';
          statusEl.textContent = `Gecrasht @ ${crashPoint.toFixed(2)}×`;
          stage.classList.add('shake'); setTimeout(()=>stage.classList.remove('shake'), 620);
          // history (lose unless paidOut)
          const payout = paidOut ? Math.floor(bet * paidOut) : 0;
          pushHistory({ts:Date.now(), seed: (seedEl.value||'').trim() || null, crash: crashPoint, bet, cash: paidOut||null, payout});
          drawCurve(currentMult);
          return;
        }

        // auto cash?
        if(isFinite(goal) && !paidOut && currentMult >= goal){
          doCash(bet); // auto cash immediately
        }

        bigMult.textContent = currentMult.toFixed(2)+'×';
        drawCurve(currentMult);
        rafId = requestAnimationFrame(frame);
      }
      rafId = requestAnimationFrame(frame);
    }

    function doCash(bet){
      if(!running || crashed || paidOut) return;
      paidOut = currentMult; // store multiplier at cash
      const payout = Math.floor(bet * paidOut);
      Bits.add(payout);
      lastWinEl.textContent = String(payout);
      statusEl.textContent = `Gecashed @ ${paidOut.toFixed(2)}× → +${payout} Bits`;
      cashBtn.disabled = true;
      launchConfetti();
      // we blijven doorlopen totdat crash of user stopt; maar disable nog een cash
    }

    function cashOutClick(){
      const bet = Math.max(1, parseInt(betEl.value,10)||1);
      doCash(bet);
    }

    function hardReset(){
      resetStage();
    }

    // Wire up
    startBtn.addEventListener('click', startRound);
    cashBtn .addEventListener('click', cashOutClick);
    resetBtn.addEventListener('click', hardReset);

    // Init
    resetStage();
    clearChart();
  </script>
</body>
</html>
